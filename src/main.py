import os
import datetime
import json
from groq import Groq
from collector import Collector
from database import ArgusDB
from notifier import SlackNotifier

# Groq í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
client = Groq(
    api_key=os.environ.get("GROQ_API_KEY"),
)

# [ì‚¬ìš©ì ì§€ì • ëª¨ë¸ ìƒìˆ˜í™”]
GROQ_MODEL_ID = "meta-llama/llama-4-maverick-17b-128e-instruct"

def generate_report_content(cve_data, reason):
    """
    Groq AIë¥¼ ì‚¬ìš©í•˜ì—¬ í•œê¸€ ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
    Model: meta-llama/llama-4-maverick-17b-128e-instruct (User Fixed)
    """
    
    # AIì—ê²Œ ì¤„ í”„ë¡¬í”„íŠ¸
    prompt = f"""
    You are a Cyber Security Analyst. Analyze the following CVE vulnerability and write a report in KOREAN.
    
    [Input Data]
    CVE ID: {cve_data['id']}
    CVSS: {cve_data['cvss']}
    Description: {cve_data['description']}
    Reason: {reason}
    
    [Output Requirements]
    1. Language: Korean (í•œêµ­ì–´)
    2. Format: Markdown
    3. Structure:
       - ğŸ›‘ **ìš”ì•½ (Summary)**: 2-3 sentences explaining the vulnerability simply.
       - ğŸ” **ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ (Technical Details)**: What is the attack vector?
       - ğŸ›¡ï¸ **ëŒ€ì‘ ë°©ì•ˆ (Mitigation)**: General advice based on the description.
    4. Do NOT translate technical terms like 'Buffer Overflow', 'RCE', 'SQL Injection'.
    """

    ai_analysis = ""
    try:
        # [ì¤‘ìš”] ì‚¬ìš©ì ì§€ì • ëª¨ë¸ ì ìš©
        chat_completion = client.chat.completions.create(
            messages=[
                {
                    "role": "user",
                    "content": prompt,
                }
            ],
            model=GROQ_MODEL_ID, # ì—¬ê¸°ì— ì§€ì •ëœ ëª¨ë¸ ID ì‚¬ìš©
            temperature=0.3,     # ë³´ì•ˆ ë¶„ì„ì´ë¯€ë¡œ ì°½ì˜ì„±ë³´ë‹¤ëŠ” ì •í™•ì„±(0ì— ê°€ê¹ê²Œ)
        )
        ai_analysis = chat_completion.choices[0].message.content
    except Exception as e:
        print(f"[WARN] Groq AI Failed ({GROQ_MODEL_ID}): {e}")
        # ì‹¤íŒ¨ ì‹œ ì›ë¬¸ ì„¤ëª…ìœ¼ë¡œ ëŒ€ì²´ (Fallback)
        ai_analysis = f"âš ï¸ **AI ë¶„ì„ ì‹¤íŒ¨ (ëª¨ë¸ ì˜¤ë¥˜)**\n\nì›ë¬¸ ì„¤ëª…:\n{cve_data['description']}"

    # ìµœì¢… ë¦¬í¬íŠ¸ ì¡°ë¦½
    return f"""
# ğŸ›¡ï¸ Argus Threat Intelligence Report
**Target:** {cve_data['id']}
**Detected At:** {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
**Risk Level:** {reason}

---

## ğŸ“Š Risk Assessment
- **CVSS Score:** {cve_data['cvss']} / 10.0
- **EPSS Score:** {cve_data['epss']*100:.2f}% (ì‹¤ì œ ê³µê²© í™•ë¥ )
- **KEV(ì‹¤ì œ ì•…ìš©):** {'ğŸš¨ YES (CISA ê²½ê³ )' if cve_data['is_kev'] else 'No'}

---

## ğŸ¤– AI Security Analysis (Korean)
**Model:** `{GROQ_MODEL_ID}`

{ai_analysis}

---
*Generated by Argus-AI*
    """

def main():
    print("[*] Argus Phase 0 Scanner Started")
    
    # 1. ì´ˆê¸°í™”
    collector = Collector()
    db = ArgusDB()
    notifier = SlackNotifier()
    
    # 2. ì „ì—­ ë°ì´í„° ë¡œë“œ (KEV, EPSS)
    collector.fetch_kev()
    
    # 3. ëŒ€ìƒ ì‹ë³„ (ìµœê·¼ ë³€ê²½ëœ CVE)
    # GitHub Schedulerê°€ 1ì‹œê°„ë§ˆë‹¤ ëˆë‹¤ë©´ 2ì‹œê°„ ì „ë¶€í„° ì¡°íšŒí•˜ì—¬ ëˆ„ë½ ë°©ì§€
    target_cve_ids = collector.fetch_recent_cves(hours=50) 
    
    if not target_cve_ids:
        print("[*] No new CVEs found.")
        return

    # EPSS ë°°ì¹˜ ë¡œë“œ
    collector.fetch_epss(target_cve_ids)
    
    print(f"[*] Processing {len(target_cve_ids)} CVEs...")

    for cve_id in target_cve_ids:
        try:
            # 4. ë°ì´í„° ì¡°ë¦½ (Enrichment)
            raw_data = collector.enrich_cve(cve_id)
            
            current_state = {
                "id": cve_id,
                "cvss": raw_data['cvss'],
                "epss": collector.epss_cache.get(cve_id, 0.0),
                "is_kev": cve_id in collector.kev_set,
                "description": raw_data['description']
            }
            
            # 5. DB ìƒíƒœ ì¡°íšŒ
            last_record = db.get_cve(cve_id)
            last_state = last_record['last_alert_state'] if last_record else None
            
            should_alert = False
            alert_reason = ""
            
            # 6. ì•Œë¦¼ ê²°ì • ë¡œì§ (Decision Matrix)
            
            # (A) KEV ì‹ ê·œ ë“±ì¬ (ìµœìš°ì„ )
            if current_state['is_kev']:
                if not last_state or not last_state.get('is_kev'):
                    should_alert = True
                    alert_reason = "CRITICAL: CISA KEV ë“±ì¬"

            # (B) EPSS >= 0.1 (High Risk)
            elif current_state['epss'] >= 0.1:
                # ì²« ì•Œë¦¼ì´ê±°ë‚˜, EPSSê°€ ìœ ì˜ë¯¸í•˜ê²Œ ìƒìŠ¹í–ˆì„ ë•Œ (0.05 ì´ìƒ)
                if not last_state:
                    should_alert = True
                    alert_reason = f"HIGH RISK: EPSS {current_state['epss']}"
                elif (current_state['epss'] - last_state.get('epss', 0)) > 0.05:
                     should_alert = True
                     alert_reason = f"ESCALATION: EPSS Surge (+{(current_state['epss'] - last_state.get('epss', 0)):.2f})"

            # (C) Medium Risk (EPSS 1% ì´ìƒ + CVSS High)
            elif 0.01 <= current_state['epss'] < 0.1:
                if current_state['cvss'] >= 7.0:
                    if not last_state:
                        should_alert = True
                        alert_reason = "MEDIUM RISK: High CVSS + Rising EPSS"

            # 7. ì•Œë¦¼ ì‹¤í–‰
            if should_alert:
                print(f"[!] Sending Alert for {cve_id}")
                
                # ë¦¬í¬íŠ¸ ìƒì„± ë° ì—…ë¡œë“œ
                report_content = generate_report_content(current_state, alert_reason)
                report_url = db.upload_report(cve_id, report_content)
                
                # Slack ì „ì†¡
                notifier.send_alert(current_state, alert_reason, report_url['signedURL'])
                
                # DB ì—…ë°ì´íŠ¸ ë°ì´í„° ì¤€ë¹„ (ì•Œë¦¼ ë³´ëƒ„ í‘œì‹œ)
                upsert_data = {
                    "id": cve_id,
                    "published_date": datetime.datetime.now().isoformat(), # cve.org ì›ë³¸ ë‚ ì§œ íŒŒì‹± í•„ìš”í•˜ë‚˜ MVPì—ì„  í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ëŒ€ì²´ ê°€ëŠ¥
                    "cvss_score": current_state['cvss'],
                    "epss_score": current_state['epss'],
                    "is_kev": current_state['is_kev'],
                    "last_alert_at": datetime.datetime.now().isoformat(),
                    "last_alert_state": current_state,
                    "updated_at": datetime.datetime.now().isoformat()
                }
            else:
                # ì•Œë¦¼ì€ ì•ˆ ë³´ë‚´ì§€ë§Œ DB ìƒíƒœëŠ” ìµœì‹ í™” (ëª¨ë‹ˆí„°ë§ìš©)
                upsert_data = {
                    "id": cve_id,
                    "cvss_score": current_state['cvss'],
                    "epss_score": current_state['epss'],
                    "is_kev": current_state['is_kev'],
                    "updated_at": datetime.datetime.now().isoformat()
                    # last_alert_atì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
                }
            
            # 8. DB ì €ì¥
            db.upsert_cve(upsert_data)
            
        except Exception as e:
            print(f"[ERR] Error processing {cve_id}: {e}")
            continue

if __name__ == "__main__":
    main()